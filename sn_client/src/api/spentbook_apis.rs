// Copyright 2022 MaidSafe.net limited.
//
// This SAFE Network Software is licensed to you under The General Public License (GPL), version 3.
// Unless required by applicable law or agreed to in writing, the SAFE Network Software distributed
// under the GPL Licence is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied. Please review the Licences for the specific language governing
// permissions and limitations relating to use of the SAFE Network Software.

use super::Client;

use crate::Error;

use sn_dbc::{KeyImage, RingCtTransaction, SpentProof, SpentProofShare};
use sn_interface::{
    messaging::data::{DataCmd, DataQueryVariant, QueryResponse, SpentbookCmd, SpentbookQuery},
    types::SpentbookAddress,
};

use xor_name::XorName;

impl Client {
    //----------------------
    // Write Operations
    //---------------------

    /// Spend a DBC's key image.
    #[instrument(skip(self), level = "debug")]
    pub async fn spend_dbc(
        &self,
        key_image: KeyImage,
        tx: RingCtTransaction,
        spent_proofs: Vec<SpentProof>,
        spent_transactions: Vec<RingCtTransaction>,
    ) -> Result<(), Error> {
        let cmd = SpentbookCmd::Spend {
            key_image,
            tx,
            spent_proofs,
            spent_transactions,
        };
        self.send_cmd(DataCmd::Spentbook(cmd)).await
    }

    //----------------------
    // Read Spentbook
    //---------------------

    /// Return the set of spent proof shares if the provided DBC's key image is spent
    #[instrument(skip(self), level = "debug")]
    pub async fn spent_proof_shares(
        &self,
        key_image: KeyImage,
    ) -> Result<Vec<SpentProofShare>, Error> {
        let address = SpentbookAddress::new(XorName::from_content(&key_image.to_bytes()));
        let query = DataQueryVariant::Spentbook(SpentbookQuery::SpentProofShares(address));
        let query_result = self.send_query(query).await?;
        match query_result.response {
            QueryResponse::SpentProofShares((res, op_id)) => {
                res.map_err(|err| Error::ErrorMsg { source: err, op_id })
            }
            _ => Err(Error::ReceivedUnexpectedEvent),
        }
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::utils::test_utils::{create_test_client, init_logger};
    use eyre::Result;
    use sn_dbc::{rng, Dbc, Owner, OwnerOnce, TransactionBuilder};

    fn new_dbc(dbc_hex: &str) -> Result<Dbc> {
        let mut dbc_str = hex::decode(dbc_hex)?;

        dbc_str.reverse();
        let dbc = bincode::deserialize(&dbc_str)?;
        Ok(dbc)
    }

    #[tokio::test(flavor = "multi_thread")]
    async fn test_spentbook_spend_dbc() -> Result<()> {
        init_logger();

        let client = create_test_client().await?;

        let sk = bls::SecretKey::random();
        let pk = sk.public_key();
        let key_image = KeyImage::from_bytes(pk.to_bytes())?;

        // Check the spentbook is empty for this key_image
        let spent_proof_shares = client.spent_proof_shares(key_image).await?;
        assert_eq!(spent_proof_shares.len(), 0);

        let input_dbc = new_dbc(DBC_WITH_1_530_000_000)?;

        let output_owner = OwnerOnce::from_owner_base(Owner::from(pk), &mut rng::thread_rng());
        let dbc_builder = TransactionBuilder::default()
            .set_decoys_per_input(0)
            .set_require_all_decoys(false)
            .add_input_dbc_bearer(&input_dbc)?
            .add_output_by_amount(1_530_000_000, output_owner)
            .build(&mut rng::thread_rng())?;

        assert_eq!(dbc_builder.inputs().len(), 1);
        let (_, tx) = &dbc_builder.inputs()[0];

        let spent_proofs = input_dbc.spent_proofs.into_iter().collect::<Vec<_>>();
        let spent_transactions = input_dbc.spent_transactions.into_iter().collect::<Vec<_>>();

        // Spend the key_image.
        client
            .spend_dbc(key_image, tx.clone(), spent_proofs, spent_transactions)
            .await?;

        // Get spent proof shares for the key_image
        let spent_proof_shares = client.spent_proof_shares(key_image).await?;

        // TODO: we should have 'spent_proof_shares' client API to contact at least
        // a supermajority of Elders for writing and reading Spentbooks, this is why now we don't
        // obtain a supermajority of spent proof shares yet.
        assert!(spent_proof_shares.len() >= 2);

        Ok(())
    }

    const DBC_WITH_1_530_000_000: &str = "5b27e8998542c6ae461c20bbb764da84b16721c795fa5ec73db3d109a68dcdded655d1c1ed7d2106ac1d12558049bab64581076215747dbbff95397a32a3d3848ceb318cf6dd5b371a2e2e910e0697972fb69d93e07de0d4387c3e4dfa2d59bdf91debc36b3bc8c45c3fa390e9bbb492ba54cdaca5bd94544a56f8d209b8876fa3e5eeef1e9d624a4b65c2627983dfbc3ef0f2cb1b815c3748052525fb7bdab933a5fdfc39d7dac1f657bd63f3c64d9e7601e031455e5b49479aa82c87c6cd944bba03423f7099c695593a94247b64a5bb32eccc0ad9fdbb89fb278d415a382761a130301e29d5673635b459b7932f2454d2e64e0489adc4a037e0b5bd6f9793fe52c8fba9405d0ef7eed48a296f9e070ec6961484490788bf629f2151bddd6097f63dd53274cd0df1693e96b8d3179619a05259fb25c7912520468a0abd1731535bdecf6b4f5497429dda47268d24f9f203eebac6978739a5d0d91358f84bb1f64712c83e8ed825fd1beaa06d63189fdfada90df84705f959681b4b34d58f8843dbe98bff97f87a3df4d235859c75b4642dec1566cd196f01d9665aa24597131c3c36bf5893a27136fd6fbb1c5b14c435c6914e9340b7ea5c522c834137c9b9eae762481905a04514e4ced0f048daedf7298f9ae16588f799e527963c9c7be9c89505652b62d0cf035a24ff6ab4fcaa41e9e19b217750ca2a2e6a23e14c4b54511dac6823a4e90ff077c447c941ffe75d6ddbc91939a7dbd6e0d98b01c1b0a8cb9bef1675e22939d113f23e4f245003e82051c5e4d6a37cfb87e4baf3e185f9fc4d11a7df03a191e9689eb9c07aa9ad831789577bc12446c65c29ebc7b16c022bad0e2fb1b96ba77785c6fcf60babd7c559445a42396e0f515efdf44f6058b7dfdad0345b748c4ed5ed3bd6b44e1056d54a35d05c1227db3dd194c64b30c6555622351ace8198bfcc47b57e7f7b3699032746711350a17e74207613b4395e58b892e0f1eb258ccffbc9d44f520216496fd8999d432a9a9825854e71dfe242da51f6ed909431ac766ca6e421318337425d5cb0a8794c2fa062a6575615049ad9359b493b72b51e7d5c54e23e521fd82698deffe4d9968120be1921e8288930d15d298abe9527757aecc35d87e7ec98f9ce68193e966e32274e0dd4be7dc4eda480fb9ed581053f51451e4fcd44ec292c42f9c23d40016409a097100674745fcda19603a9d4bcb3990e641ade096d7db2edc340fb0e63eca1d4a7a5e4fd2f6d9bba29f5fb69cb2053d403982672689126045e946fedd54ad97b71f9c908e40e91aa430fc12b42dcd3cd46ccac89e45828ec770bdb7963332e4afca6b2e79fd5ce4ab681cbf214e2d1b5f97f30ef1b379400000000000003a022f7884d31afa7d6290ac827610f8d1b3ac85b23d772aad211432020dc6ef7fb3b16caff655e8033f23a5a02e70a14853a153d1f310223795eedd09b7174755e42cf9ab2450e1dd5e913e5939017a2e288d521d9abfbdced62f2139aaa9bd1a030f012e75822f069d9efb8b06594c2ab3cf51631b8451bfe1289e39ae3263ca965d7dd887ca70a8d4a24fa740ea6737ef0989e55298c08c861ddea293c2112f154cc68813af354ca1e376b87b6b95504b7373fe142fddbc9bd649236bef035d1f75c14fe2b50b580ad993df6a4e5e6b855ecfa165e660beefe0b1160f2b8aebea8458cb3b4bffa99b49ec364ce39dacc8adbc388fe5c519c3428ff33e8a3238c7c17bbd748c7412432b6ca1937d02991b094e8f1b96f30df799bae9a9959d922543100fb32eb35f206ab6f875e1058b6aaaeb57e4e878fcf01d8d700c5ce619cc0c856635d1ebba1c0f031eee8a7fc4a5587a3c1acea24f6c5bbf67e8a366098091452e3412cf42360840395016ebfc882d49a9b5986e59995521b14c0645d586f4ca9afd58b90680f9f7dcf304156aeee1bf0a07517d7f12d5e1124d7fd14429214598a15b6096bac99fa59d8b8243a228953eba44f4e4df22a369f52a72da4b91fae2fb0803074f453f5f8c7ab586caeac5805f2891de74a3c5cfadc4b5bf425ae802f067f6a5a54f7564309e74fb938ca81610f88cde01aaa999306474fb49ca31994619c1c76351487efef558f8c8dd8140c9de805f40c9c8b8b152b55a5b0c61b5ff26d194f39aec49659790a8b761c837b6acb377e790798b2ff1fede7d460c146b62159c25ed50a5f58a683941668e8b849065668ecf4e380165f3029e64686d8b1f0f8ec53d4914da9612805272153be3e3e10855e7b81a4914c90ab770d72859a442055b0a3c143a435f45758ba5650da7e85cbe1f99fc04a17f993b2d092163a22ec397b01a7e37dddee80fc81b1a5244c5b4e4d06d28dd7e0e09ab2892f0b902fbc085d715a9380ac1181817975c7fa1a0df62997d2c69270f9aa2e6215c55fd92143d064119d1b283e58c46b5ebaf36ca9f1a99e10b4952423b705fea91fb697d40e5caeb1f6ca2f164dea7bd9571bf810e8aba02ce522319bfb1eacf38dc1dfb953b47833191bb695eef377f44be0753dd8abde493e413008a37ec5ebdce084d0e2cff8348f3e4208af9ed6605398f0ab2975a5d0547c67b59b9969991bcea289370e4989c749b31e8469c76f643e2cdc5bf07e7f0e4b34374cd29a305933a482667782ce7d94041fabc74c5acd5868ea15824eeb89ade841b541ad49c28a4fc10183ed1118b5db3ba997c5635fa0e4f7ed0580280e8184e3ae743f286c9d7a048a64c0dd262c80769915b66169bf7a1f1c52bbcbb508d8bcfcd9b0c392e01a638f30cb7def3c74ed3bd5de7e794a71630d8055fa10ba858f8200000000000003a07f7a21e7168519441c7c08df4df085df9016351e4f001d6bc5df9bff21e570470a34546aa7b733fdcd338c547bae02810000000000000002f5435dd67154de0c0d36d338d1282a35bfb31ccefca42a4786aac034115fc76fe6a39deb556ee1cb58682b8216ce989235f556ccfbfb57b54f658262c8b2748b32e076d5e81cd8837f2b86900ca7b27f586955006b54b10ed304ee7c4fd8318996535faeae2d5b27e4c0b37f2d8667128dbe048a2814ce4d24fc60f7a0dda7c87e1d3b30254c25aba701ff6eeb9ebe8800000000000000011ca2ae5ab0ed3dc52cc9cd341c4a482e9d9f5f2d81d981a11032821603b863baa19a900087052a2f799092f29d7e2c8b548303a73305fc9c94eada44863144d84b6f9088a6280ff1b54cf540dc6c4ded457121351f13df5ffd94cb9764079dede3220daca7d85f61d5092eaca480b7b500000000000000013f80a95efa16af78eceb4d770980e57c9f2ef4939db4fd6233e71179b281c30c0000000000000001000000000000000140bf4b37d26b0d348e8b6971ae02f1b8f4c45464d730cff075dba8dc16b3ebe83bdd0967eca3217ec4a66448829271052ede75124f072c1428102aa508a9cd83b4ee63f52d19764068efe798e3d96ae8004e2496ed626daa8fc3277c1b2aeb981f6d0adfbd03542f93053fa4056d0ce36018ebb704258d130a797471ce3a0d1802c05a7f578a1bf4851975549b2bf0b038aab683457882ebc8dc80cd829f9e292837a00789952636524a544ae1fada10439ed9478b6d0127c5fd13ed74e9e1870000000000000001fa3523c0c909f6104727a3148f3469aedf9626c9421c030dd52e65dc057914211ca2ae5ab0ed3dc52cc9cd341c4a482e9d9f5f2d81d981a11032821603b863baa19a900087052a2f799092f29d7e2c8b00000000000000015b27e8998542c6ae461c20bbb764da84b16721c795fa5ec73db3d109a68dcdded655d1c1ed7d2106ac1d12558049bab64581076215747dbbff95397a32a3d3848ceb318cf6dd5b371a2e2e910e0697972fb69d93e07de0d4387c3e4dfa2d59bdf91debc36b3bc8c45c3fa390e9bbb492ba54cdaca5bd94544a56f8d209b8876fa3e5eeef1e9d624a4b65c2627983dfbc3ef0f2cb1b815c3748052525fb7bdab933a5fdfc39d7dac1f657bd63f3c64d9e7601e031455e5b49479aa82c87c6cd944bba03423f7099c695593a94247b64a5bb32eccc0ad9fdbb89fb278d415a382761a130301e29d5673635b459b7932f2454d2e64e0489adc4a037e0b5bd6f9793fe52c8fba9405d0ef7eed48a296f9e070ec6961484490788bf629f2151bddd6097f63dd53274cd0df1693e96b8d3179619a05259fb25c7912520468a0abd1731535bdecf6b4f5497429dda47268d24f9f203eebac6978739a5d0d91358f84bb1f64712c83e8ed825fd1beaa06d63189fdfada90df84705f959681b4b34d58f8843dbe98bff97f87a3df4d235859c75b4642dec1566cd196f01d9665aa24597131c3c36bf5893a27136fd6fbb1c5b14c435c6914e9340b7ea5c522c834137c9b9eae762481905a04514e4ced0f048daedf7298f9ae16588f799e527963c9c7be9c89505652b62d0cf035a24ff6ab4fcaa41e9e19b217750ca2a2e6a23e14c4b54511dac6823a4e90ff077c447c941ffe75d6ddbc91939a7dbd6e0d98b01c1b0a8cb9bef1675e22939d113f23e4f245003e82051c5e4d6a37cfb87e4baf3e185f9fc4d11a7df03a191e9689eb9c07aa9ad831789577bc12446c65c29ebc7b16c022bad0e2fb1b96ba77785c6fcf60babd7c559445a42396e0f515efdf44f6058b7dfdad0345b748c4ed5ed3bd6b44e1056d54a35d05c1227db3dd194c64b30c6555622351ace8198bfcc47b57e7f7b3699032746711350a17e74207613b4395e58b892e0f1eb258ccffbc9d44f520216496fd8999d432a9a9825854e71dfe242da51f6ed909431ac766ca6e421318337425d5cb0a8794c2fa062a6575615049ad9359b493b72b51e7d5c54e23e521fd82698deffe4d9968120be1921e8288930d15d298abe9527757aecc35d87e7ec98f9ce68193e966e32274e0dd4be7dc4eda480fb9ed581053f51451e4fcd44ec292c42f9c23d40016409a097100674745fcda19603a9d4bcb3990e641ade096d7db2edc340fb0e63eca1d4a7a5e4fd2f6d9bba29f5fb69cb2053d403982672689126045e946fedd54ad97b71f9c908e40e91aa430fc12b42dcd3cd46ccac89e45828ec770bdb7963332e4afca6b2e79fd5ce4ab681cbf214e2d1b5f97f30ef1b379400000000000003a022f7884d31afa7d6290ac827610f8d1b3ac85b23d772aad211432020dc6ef7fb3b16caff655e8033f23a5a02e70a14853a153d1f310223795eedd09b7174755e42cf9ab2450e1dd5e913e5939017a2e288d521d9abfbdced62f2139aaa9bd1a030f012e75822f069d9efb8b06594c2ab3cf51631b8451bfe1289e39ae3263ca965d7dd887ca70a8d4a24fa740ea6737ef0989e55298c08c861ddea293c2112f154cc68813af354ca1e376b87b6b95504b7373fe142fddbc9bd649236bef035d1f75c14fe2b50b580ad993df6a4e5e6b855ecfa165e660beefe0b1160f2b8aebea8458cb3b4bffa99b49ec364ce39dacc8adbc388fe5c519c3428ff33e8a3238c7c17bbd748c7412432b6ca1937d02991b094e8f1b96f30df799bae9a9959d922543100fb32eb35f206ab6f875e1058b6aaaeb57e4e878fcf01d8d700c5ce619cc0c856635d1ebba1c0f031eee8a7fc4a5587a3c1acea24f6c5bbf67e8a366098091452e3412cf42360840395016ebfc882d49a9b5986e59995521b14c0645d586f4ca9afd58b90680f9f7dcf304156aeee1bf0a07517d7f12d5e1124d7fd14429214598a15b6096bac99fa59d8b8243a228953eba44f4e4df22a369f52a72da4b91fae2fb0803074f453f5f8c7ab586caeac5805f2891de74a3c5cfadc4b5bf425ae802f067f6a5a54f7564309e74fb938ca81610f88cde01aaa999306474fb49ca31994619c1c76351487efef558f8c8dd8140c9de805f40c9c8b8b152b55a5b0c61b5ff26d194f39aec49659790a8b761c837b6acb377e790798b2ff1fede7d460c146b62159c25ed50a5f58a683941668e8b849065668ecf4e380165f3029e64686d8b1f0f8ec53d4914da9612805272153be3e3e10855e7b81a4914c90ab770d72859a442055b0a3c143a435f45758ba5650da7e85cbe1f99fc04a17f993b2d092163a22ec397b01a7e37dddee80fc81b1a5244c5b4e4d06d28dd7e0e09ab2892f0b902fbc085d715a9380ac1181817975c7fa1a0df62997d2c69270f9aa2e6215c55fd92143d064119d1b283e58c46b5ebaf36ca9f1a99e10b4952423b705fea91fb697d40e5caeb1f6ca2f164dea7bd9571bf810e8aba02ce522319bfb1eacf38dc1dfb953b47833191bb695eef377f44be0753dd8abde493e413008a37ec5ebdce084d0e2cff8348f3e4208af9ed6605398f0ab2975a5d0547c67b59b9969991bcea289370e4989c749b31e8469c76f643e2cdc5bf07e7f0e4b34374cd29a305933a482667782ce7d94041fabc74c5acd5868ea15824eeb89ade841b541ad49c28a4fc10183ed1118b5db3ba997c5635fa0e4f7ed0580280e8184e3ae743f286c9d7a048a64c0dd262c80769915b66169bf7a1f1c52bbcbb508d8bcfcd9b0c392e01a638f30cb7def3c74ed3bd5de7e794a71630d8055fa10ba858f8200000000000003a07f7a21e7168519441c7c08df4df085df9016351e4f001d6bc5df9bff21e570470a34546aa7b733fdcd338c547bae02810000000000000002f5435dd67154de0c0d36d338d1282a35bfb31ccefca42a4786aac034115fc76fe6a39deb556ee1cb58682b8216ce989235f556ccfbfb57b54f658262c8b2748b32e076d5e81cd8837f2b86900ca7b27f586955006b54b10ed304ee7c4fd8318996535faeae2d5b27e4c0b37f2d8667128dbe048a2814ce4d24fc60f7a0dda7c87e1d3b30254c25aba701ff6eeb9ebe8800000000000000011ca2ae5ab0ed3dc52cc9cd341c4a482e9d9f5f2d81d981a11032821603b863baa19a900087052a2f799092f29d7e2c8b548303a73305fc9c94eada44863144d84b6f9088a6280ff1b54cf540dc6c4ded457121351f13df5ffd94cb9764079dede3220daca7d85f61d5092eaca480b7b500000000000000013f80a95efa16af78eceb4d770980e57c9f2ef4939db4fd6233e71179b281c30c000000000000000117b4bfcd5437771b00ce5d6fc6f604576e621cd12754539817b1ec4a6923780443e64fff60cd8adbeaca4f1d80e0f50ecdd1a86fb6a266f6eac665ba26afa828bb5badd9844262740d78bd453057a075e5beb72a437f6a6937c941cc7bb9318c52963d0c8fd7eac17088fbafa7a0de5c5703582dadd2df0ad059e859b5c38865edbe24f57ad896eb0000000000000028c931b6d85bc74c955eba7b2da84c3972aaf8131d412dcdef7b127ec7a867d45336d27907b4408369c38f1552a6ec3e840c7bd599224f0278cb63f5f02421dd9fb9ce203f9d818bd164bd3ef114ea1c80072bae0c8d2809c9ead4b4fe6744940a1b15241bd165f974c729fc16599dd5013bbfef692d01a8ff8a1f0b7ac8f03efea80de71961d60e9c2325adeaddcbe28686de4a78b5a713a39e2f786a9e6f638ec8c8d1dbc6ca8f599a114fbc1201e1810000000000000020f763c2828f215f20407616362011799e83c511791fb78a18db13c7f785b83e15659c158be1e6837ce88162954f1c9c892bb869ec22db0154809cc9e2c9ddeada3c47928783051f20f6b56f12127fdb6900000000";
}
